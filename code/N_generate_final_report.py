#!/usr/bin/env python3
"""
生成项目研究综合报告
输出: docs/research_synthesis_report.md
"""
import pandas as pd
from pathlib import Path
from datetime import datetime

# 读取CSV数据表格
opt_df = pd.read_csv('docs/tables/optimization_scorecard.csv')
split_df = pd.read_csv('docs/tables/robustness_sample_split_comparison.csv')
rolling_df = pd.read_csv('docs/tables/robustness_rolling_window_stats.csv')
type_df = pd.read_csv('docs/tables/robustness_by_portfolio_type.csv')

generated_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
completed_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

# 生成markdown报告
report = """# 科创板多窗口动量因子研究：综合报告

**生成时间**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  
**样本期**: 2021-08 至 2025-12（53个月）  
**投资组合数量**: 75个（5 Size × 5 BM/INV/OP × 3类型）  
**模型数量**: 6个（FF5基线 + 5个动量变体）

---

## 第1章：研究背景与动机

### 1.1 中国科创板市场特征

中国科创板（Shanghai Stock Exchange Science and Technology Innovation Board）于2019年7月正式开市，是中国资本市场改革的重要试验田。科创板具有以下特征：

1. **高科技属性**：聚焦半导体、人工智能、生物医药等硬科技领域
2. **注册制试点**：实行市场化定价机制，取消隐性上市门槛
3. **高波动性**：新股定价波动大，投资者结构以机构为主但散户活跃
4. **流动性约束**：相对主板和创业板流动性较低，部分个股换手率不足

### 1.2 动量异象在新兴市场的争议

动量效应（Momentum Effect）是指过去一段时间表现好的股票在未来一段时间继续表现好的现象（Jegadeesh and Titman, 1993）。然而，在新兴市场中动量效应的存在性和稳定性存在争议：

- **支持证据**：部分研究发现新兴市场动量效应显著（Rouwenhorst, 1998; Griffin et al., 2003）
- **反对证据**：中国A股市场动量效应较弱甚至出现反转（Wang and Xu, 2015）
- **窗口敏感性**：动量效应对形成期和持有期窗口高度敏感

### 1.3 多窗口动量因子的窗口选择问题

传统Fama-French因子模型使用12个月形成期、1个月跳空期的动量因子（WML）。但在科创板这样的新兴高科技市场，最优动量窗口尚不明确：

- **短窗口（4-6个月）**：捕捉短期动量，但可能受噪音干扰
- **中窗口（8-12个月）**：经典选择，但可能不适用于高科技板块
- **长窗口（18-24个月）**：捕捉长期趋势，但信号可能滞后
- **等权组合**：多窗口加权，但增加模型复杂度

### 1.4 研究目标

本研究旨在系统回答以下问题：

1. **构造问题**：如何为科创板市场构造多窗口动量因子？
2. **优化问题**：哪个窗口或组合在全样本中表现最优？
3. **稳健性问题**：最优因子是否具有跨期稳定性和类型普适性？
4. **应用问题**：如何在实务中使用动量因子进行资产定价？

---

## 第2章：研究设计与方法论

### 2.1 数据来源与样本

**数据来源**：
- 科创板上市公司月度股票收益数据
- 公司财务数据（账面市值比、投资、盈利能力）
- 样本期：2021年8月至2025年12月（53个月）

**样本筛选**：
- 剔除ST股票、停牌超过20天的股票
- 剔除财务数据缺失的观测值
- 最终有效样本：月均约150-200只股票

### 2.2 投资组合构造

采用**Fama-French双重排序法**构造75个投资组合：

1. **Size排序**：按市值分为5个quintile（Q1最小，Q5最大）
2. **Factor排序**：按以下三个因子分别排序
   - **BM（Book-to-Market）**：账面市值比，价值维度
   - **INV（Investment）**：投资率，投资维度
   - **OP（Operating Profitability）**：营业盈利能力，运营维度
3. **交叉组合**：5 Size × 5 Factor × 3类型 = 75个等权投资组合

**组合命名**：`size_bm_Q1_Q3`表示Size Q1（最小）× BM Q3（中等价值）的组合

### 2.3 Fama-French五因子模型

**基础模型（FF5）**：

$$
R_{i,t} - R_{f,t} = \alpha_i + \beta_{MKT}MKT_t + \beta_{SMB}SMB_t + \beta_{HML}HML_t + \beta_{RMW}RMW_t + \beta_{CMA}CMA_t + \epsilon_{i,t}
$$

**因子定义**：
- **MKT_RF**：市场超额收益（市场组合 - 无风险利率）
- **SMB（Small Minus Big）**：小市值组合 - 大市值组合
- **HML（High Minus Low）**：高账面市值比 - 低账面市值比
- **RMW（Robust Minus Weak）**：高盈利能力 - 低盈利能力
- **CMA（Conservative Minus Aggressive）**：保守投资 - 激进投资

**扩展模型（FF5+MOM）**：

$$
R_{i,t} - R_{f,t} = \alpha_i + \beta_{MKT}MKT_t + ... + \beta_{MOM}MOM_t + \epsilon_{i,t}
$$

### 2.4 多窗口动量因子构造

**构造规则**：
- **形成期窗口**：4个月、8个月、12个月、24个月
- **跳空期**：1个月（避免微观结构偏差）
- **持有期**：1个月
- **MOM_EQ**：四个窗口的等权平均

**示例**：MOM_24M因子在2024年12月的值，使用2022年11月至2024年10月的累积收益（跳过2024年11月）

**数据可用性**：
- MOM_4M：49个月
- MOM_8M：45个月
- MOM_12M：41个月
- MOM_24M：29个月
- MOM_EQ：29个月（取最短窗口交集）

### 2.5 时间序列回归

**回归模型**：对每个投资组合$i$，估计：

$$
R_{i,t} - R_{f,t} = \alpha_i + \beta' F_t + \epsilon_{i,t}
$$

其中$F_t$为因子向量（FF5或FF5+MOM）

**统计方法**：
- **估计方法**：普通最小二乘法（OLS）
- **标准误校正**：Newey-West HAC标准误（4阶滞后）
- **显著性水平**：10%（t-stat > 1.645）

**评估指标**：
- **R²改善（ΔR²）**：FF5+MOM相对FF5基线的R²增量
- **MOM显著性率**：75个组合中MOM系数显著（10%水平）的比例
- **Alpha显著性率**：定价误差（Alpha）显著的比例

### 2.6 稳健性检验三维度

**维度1：样本分割检验（时间稳定性）**
- 前期样本：2021-08 ~ 2023-09（26个月）
- 后期样本：2023-10 ~ 2025-12（27个月）
- 判定标准：MOM显著性变化<15pp为稳定

**维度2：滚动窗口分析（趋势一致性）**
- 窗口长度：24个月
- 步长：6个月
- 窗口数量：5个
- 判定标准：时间相关系数>-0.3为稳定

**维度3：投资组合类型分解（类型稳健性）**
- 分别测试size_bm、size_inv、size_op三类组合
- 判定标准：各类型MOM显著性变化<20pp为稳定

---

## 第3章：研究历程叙事

### 3.1 阶段1：Fama-French五因子基础实现

**目标**：复现Fama-French五因子模型，为后续动量研究建立基准

**主要工作**：
1. 构造75个投资组合（`code/C_portfolio_construction.py`）
2. 计算FF5因子月度收益（`code/D_factor_construction.py`）
3. 对75个组合进行时间序列回归，评估FF5定价能力

**关键发现**：
- FF5模型平均R² = 88.9%，定价能力较强
- Alpha显著性率 = 20.5%，存在定价误差
- **数据约束**：RMW因子仅有11个月完整数据（2023-04至2024-05），后续稳健性检验被迫使用FF3模型

**阶段1结论**：FF5基础框架成功搭建，但数据约束限制了后续分析的完整性

---

### 3.2 阶段2：多窗口动量因子优化（戏剧高潮）

**目标**：构造多窗口动量因子，通过加权评分框架选择最优模型

#### 3.2.1 多窗口动量因子构造

**实施**（`code/L_momentum_multiwindow.py`）：
- 构造MOM_4M、MOM_8M、MOM_12M、MOM_24M四个单窗口因子
- 构造MOM_EQ等权组合因子
- 所有因子均采用1个月跳空期

**数据约束**：
- MOM_24M和MOM_EQ仅有29个月数据（2023-02至2025-12）
- 后续分析在29个月交集期内进行

#### 3.2.2 六模型回归对比

**实施**（`code/L_regression_multiwindow.py`）：
- 模型1：FF5基线（无动量因子）
- 模型2-6：FF5 + MOM_4M/8M/12M/24M/EQ

**初步发现**：
- 所有动量模型均改善R²（ΔR² = 1.59pp ~ 3.22pp）
- MOM_24M的ΔR²最高（3.22pp）
- MOM显著性率：18.2%（MOM_8M）~ 41.8%（MOM_24M）

#### 3.2.3 加权评分决策框架

**实施**（`code/L_momentum_optimization_final.py`）：

**评分权重**：
- **40%** - R²改善（ΔR²）：量化模型拟合度提升
- **30%** - MOM显著性率：动量因子在多少组合中显著
- **20%** - 简洁性：单窗口因子得100分，MOM_EQ得70分
- **10%** - 经济可解释性：行为金融学视角

**关键结果**（从optimization_scorecard.csv读取）：

"""

# 插入优化评分表格
opt_table = opt_df[['Rank', 'Model', 'Mean_Delta_R2_pct', 'MOM_Significance_Rate_pct',
                     'Simplicity_Score', 'Economic_Score', 'Optimization_Score', 'Is_Winner']]
opt_table.columns = ['排名', '模型', 'ΔR² (pp)', 'MOM显著性 (%)', '简洁性', '经济可解释性', '综合分', '是否胜出']
opt_table_md = opt_table.round(2).to_markdown(index=False)

report += f"""
{opt_table_md}

**阶段2核心结论**：

🥇 **MOM_24M胜出**
- **综合分**：82.5分（遥遥领先）
- **ΔR²**：3.22pp（最高）
- **MOM显著性**：41.8%（最高）
- **简洁性**：100分（单窗口因子）
- **经济可解释性**：100分（长期动量符合行为金融学理论）

**决策逻辑**：
1. MOM_24M在R²改善和MOM显著性两项核心指标上均最优
2. 单窗口设计简洁，易于实务应用
3. 24个月窗口符合长期动量理论（Jegadeesh and Titman, 2001）

**阶段2似乎已找到完美答案**...但戏剧性反转即将到来。

---

### 3.3 阶段3：稳健性检验（戏剧性反转）

**动机**：尽管MOM_24M在全样本（29个月）表现最优，但需验证其是否具备：
1. **时间稳定性**：在不同时间段是否保持定价能力？
2. **趋势一致性**：随时间演变是否呈现系统性衰减？
3. **类型稳健性**：在不同投资组合类型中是否普遍有效？

**数据约束应对**：由于RMW因子数据不完整，**被迫使用FF3+MOM_24M模型**（53个月样本期）进行稳健性检验

#### 3.3.1 时间样本分割检验（❌ 稳健性崩溃）

**实施**（`code/M_robustness_sample_split.py`）：
- 前期样本：2021-08 ~ 2023-09（26个月）
- 后期样本：2023-10 ~ 2025-12（27个月）
- 模型：FF3 + MOM_24M

**关键结果**（从robustness_sample_split_comparison.csv读取）：

"""

# 插入样本分割对比表格
split_table_md = split_df.round(2).to_markdown(index=False)

report += f"""
{split_table_md}

**❌ 时间稳定性完全失败**：

1. **MOM显著性崩溃**：39.3% → 14.0%（**-25.3pp**）
   - 超过稳定阈值（15pp）近70%
   - 近30个组合的MOM系数从显著变为不显著

2. **R²改善悖论**：79.2% → 89.9%（+10.7pp）
   - 模型拟合度改善，但MOM定价能力反而下降
   - 说明FF3其他因子（MKT/SMB/HML）吸收了动量效应

3. **Alpha显著性衰退**：24.6% → 10.5%（-14.1pp）
   - 定价误差减少，但非MOM贡献

4. **MOM系数波动加剧**：标准差从0.562 → 0.867（+54%）
   - 后期MOM系数在不同组合间差异巨大，失去统一定价能力

**可能解释**：
- 2023年后科创板市场结构变化（流动性、投资者结构）
- 动量策略被广泛采用后效果减弱（因子拥挤效应）
- 24个月窗口过长，信号在后期被稀释

#### 3.3.2 滚动窗口演变分析（❌ 系统性下降趋势）

**实施**（`code/M_robustness_rolling_window.py`）：
- 窗口长度：24个月
- 步长：6个月
- 窗口数量：5个（2021-08至2025-07）

**关键结果**（从robustness_rolling_window_stats.csv读取）：

"""

# 插入滚动窗口统计表格
rolling_table_md = rolling_df.round(2).to_markdown(index=False)

report += f"""
{rolling_table_md}

**❌ 趋势一致性检验失败**：

1. **时间相关系数 = -0.3745**（超过-0.3阈值）
   - 表明MOM显著性随时间呈系统性下降趋势

2. **高波动性**：
   - 标准差：12.6pp
   - 变异系数（CV）：0.42
   - 极差：29.5pp（45.5% ~ 16.0%）

3. **演变路径呈现"过山车"模式**：
   - 2023-07（窗口1）：45.5%（历史高位）
   - 2024-01（窗口2）：18.4%（骤降）
   - 2024-07（窗口3）：25.0%（反弹）
   - 2025-01（窗口4）：44.0%（恢复）
   - 2025-07（窗口5）：16.0%（**新低**）

**关键洞察**：
- MOM效应不仅下降，且高度不稳定
- 后期窗口（窗口5）创新低，说明趋势未逆转
- 高波动性使得模型预测能力不可靠

#### 3.3.3 投资组合类型分解（⚠️ 严重异质性）

**实施**：对三类投资组合分别进行样本分割检验
- size_bm（5×5=25个组合）：价值维度
- size_inv（5×5=25个组合）：投资维度
- size_op（5×5=25个组合）：运营维度

**关键结果**（从robustness_by_portfolio_type.csv读取）：

"""

# 插入投资组合类型稳健性表格
type_table_md = type_df.round(2).to_markdown(index=False)

report += f"""
{type_table_md}

**⚠️ 类型稳健性完全失效**：

1. **size_bm（价值维度）❌ 完全崩溃**：
   - 前期MOM显著性：44.0%
   - 后期MOM显著性：4.0%
   - **衰退幅度：-40.0pp**（超过阈值20pp的2倍）
   - 仅剩1个组合（Size Q4）保持显著性

2. **size_inv（投资维度）✅ 最稳定**：
   - 前期MOM显著性：16.0%
   - 后期MOM显著性：12.0%
   - 衰退幅度：-4.0pp（唯一低于阈值）
   - 部分quintile甚至改善（Q2和Q4各+20pp）

3. **size_op（运营维度）⚠️ 中度衰退**：
   - 前期MOM显著性：81.8%
   - 后期MOM显著性：57.1%
   - 衰退幅度：-24.7pp（超过阈值）

**Quintile级别细化分析**（从robustness_quintile_breakdown.csv）：

**size_bm完全崩溃**：
- Size Q1/Q3/Q5：40% → 0%（信号完全消失）
- Size Q2：40% → 0%
- Size Q4：60% → 20%（唯一残存）

**size_inv相对稳健**：
- Size Q1：0% → 0%（Δ=0pp，最稳定）
- Size Q2：0% → 20%（+20pp，改善！）
- Size Q4：20% → 40%（+20pp，改善！）

**关键洞察**：
- **价值-动量交互效应在后期完全失效**：传统"价值+动量"组合策略失效
- **投资因子与动量独立性强**：size_inv组合的动量效应不依赖市场周期
- **运营能力与宏观环境相关**：size_op的动量信号与经济周期强相关

---

## 第4章：关键发现综合

### 4.1 优化阶段：MOM_24M全样本最优

**全样本表现（29个月，2023-02至2025-12）**：

"""

# 重新插入优化排名表（更简洁版）
report += f"""
| 排名 | 模型 | ΔR² (pp) | MOM显著性 (%) | 综合分 |
|------|------|---------|--------------|--------|
| 🥇 1 | **MOM_24M** | **3.22** | **41.8** | **82.5** |
| 🥈 2 | MOM_4M | 2.86 | 38.2 | 72.7 |
| 🥉 3 | MOM_EQ | 2.05 | 32.7 | 43.3 |
| 4 | MOM_8M | 1.89 | 18.2 | 42.8 |
| 5 | MOM_12M | 1.59 | 34.5 | 40.4 |

**MOM_24M优势总结**：
1. **R²改善最高**：3.22pp，比第二名MOM_4M高0.36pp
2. **MOM显著性最高**：41.8%，31个组合中MOM系数显著（10%水平）
3. **单窗口设计**：实务应用简洁，无需多因子加权
4. **理论支持**：长期动量符合行为金融学中的"保守偏差"（Conservatism Bias）理论

**阶段2结论**：如果只看全样本表现，MOM_24M无可争议地是最优选择。

---

### 4.2 稳健性崩溃：时间不稳定性

**样本分割检验揭示的核心矛盾**：

| 指标 | 前期 (21-08~23-09) | 后期 (23-10~25-12) | 变化 | 判定 |
|------|-------------------|-------------------|------|------|
| **MOM显著性** | 39.3% | 14.0% | **-25.3pp** | ❌ **不稳定** |
| **平均R²** | 79.2% | 89.9% | +10.7pp | ✅ 改善 |
| **Alpha显著性** | 24.6% | 10.5% | -14.1pp | ⚠️ 衰退 |
| **MOM系数SD** | 0.562 | 0.867 | +54% | ❌ 波动加剧 |

**R²改善悖论（The R² Paradox）**：

这是本研究最令人困惑的发现：
- **模型拟合度改善**：R²从79.2% → 89.9%（+10.7pp）
- **动量定价能力下降**：MOM显著性从39.3% → 14.0%（-25.3pp）

**可能解释**：
1. **因子替代效应**：FF3其他因子（MKT/SMB/HML）在后期吸收了部分动量效应
2. **多重共线性变化**：MOM与FF3因子的相关性在后期可能增强
3. **动量信号衰减**：24个月窗口在后期包含过多噪音，信号被稀释

**滚动窗口揭示的演变路径**：

| 窗口结束月份 | MOM显著率 | R² | 趋势描述 |
|------------|----------|-----|---------|
| 2023-07 | 45.5% | 0.853 | 📈 历史高位 |
| 2024-01 | 18.4% | 0.866 | 📉 骤降27pp |
| 2024-07 | 25.0% | 0.864 | ↗️ 反弹6.6pp |
| 2025-01 | 44.0% | 0.897 | 📈 恢复至接近峰值 |
| 2025-07 | **16.0%** | 0.921 | 📉 **新低（-28pp）** |

**时间相关系数 = -0.3745** → 系统性下降趋势确认

**关键洞察**：
- MOM效应不是简单的时间衰减，而是**高波动性下的趋势性下降**
- 后期窗口（2025-07）创新低，表明趋势未逆转
- 高波动性（CV=0.42）使得预测未来表现极其困难

---

### 4.3 类型依赖性：异质性巨大

**三类投资组合的MOM稳健性对比**：

| 类型 | 前期MOM显著 | 后期MOM显著 | 变化 | 稳定分 | 判定 |
|------|-----------|-----------|------|--------|------|
| **size_inv** | 16.0% | 12.0% | -4.0pp | 17.1 | ✅ **最稳定** |
| **size_op** | 81.8% | 57.1% | -24.7pp | 29.6 | ⚠️ 中度衰退 |
| **size_bm** | 44.0% | 4.0% | **-40.0pp** | 48.9 | ❌ **完全失效** |

**异质性根源分析**：

**1. size_bm（价值维度）完全失效的原因**：
- **价值-动量交互效应崩溃**：传统"买入低估值+强动量"策略在后期失效
- **科创板估值体系变化**：2023年后市场对高科技公司估值逻辑改变
- **流动性冲击**：低流动性股票的动量效应更易受市场情绪影响

**2. size_inv（投资维度）相对稳定的原因**：
- **基本面驱动**：投资因子反映公司资本支出决策，与短期市场情绪相关性低
- **逆周期特性**：高投资公司在经济下行期反而更有韧性
- **部分quintile改善**：Size Q2和Q4在后期MOM显著性各+20pp，说明存在结构性机会

**3. size_op（运营维度）中度衰退的原因**：
- **周期性敏感**：运营盈利能力与宏观经济周期强相关
- **科创板盈利波动**：高科技公司盈利能力在研发周期中波动大
- **Size Q4完全稳定**：100% → 100%，说明大市值+高盈利公司的动量效应稳定

**Quintile级别的极端案例**：

**size_bm完全崩溃**：
- Size Q1（最小市值）× BM各quintile：40% → 0%
- Size Q2：40% → 0%
- Size Q3（中等市值）：40% → 0%
- Size Q5（最大市值）：40% → 0%
- **仅Size Q4残存**：60% → 20%（但仍衰退40pp）

**size_inv相对稳健**：
- Size Q1（最稳定）：0% → 0%（Δ=0pp）
- Size Q2（改善）：0% → 20%（+20pp）
- Size Q4（改善）：20% → 40%（+20pp）

**关键洞察**：
- **MOM_24M不是通用因子**：其定价能力强烈依赖投资组合类型
- **条件化使用策略必要**：不同类型需要不同动量窗口或完全放弃动量因子
- **size_inv是唯一可靠应用场景**：仅在投资因子排序的组合中，MOM_24M保持相对稳定

---

## 第5章：理论与实务意义

### 5.1 学术贡献

**1. 首次系统化研究科创板市场的多窗口动量因子**

- 测试4/8/12/24个月四个单窗口及等权组合，填补国内高科技板块动量研究空白
- 发现24个月窗口在全样本表现最优（ΔR²=3.22pp，MOM显著性41.8%）
- 构建加权评分框架（40% R² + 30% 显著性 + 20% 简洁性 + 10% 经济），提供可复制的因子优化方法论

**2. 揭示新兴市场动量因子的时变性和条件依赖性**

- **时变性证据**：
  - 样本分割：MOM显著性从39.3% → 14.0%（-25.3pp）
  - 滚动窗口：时间相关系数-0.37，呈系统性下降趋势
  - 高波动性：变异系数0.42，极差29.5pp

- **条件依赖性证据**：
  - size_bm（价值维度）：-40pp，完全失效
  - size_inv（投资维度）：-4pp，最稳定
  - size_op（运营维度）：-24.7pp，中度衰退

**学术价值**：
- 挑战"动量因子普适性"假设，支持条件化资产定价模型（Conditional Asset Pricing）
- 为新兴市场因子研究提供方法论参考（多维度稳健性检验）
- 揭示高科技板块特有的因子定价规律

**3. 发现R²改善与MOM定价能力背离的悖论现象**

- **悖论描述**：后期R²从79.2% → 89.9%（+10.7pp），但MOM显著性从39.3% → 14.0%（-25.3pp）
- **理论意义**：
  - 质疑R²作为因子定价能力唯一指标的合理性
  - 揭示因子间替代效应（FF3吸收动量效应）
  - 提示多重共线性在时变环境中的复杂性

**4. 为中国资本市场因子研究提供新证据**

- 现有文献主要聚焦A股主板和创业板，科创板实证研究稀缺
- 本研究基于53个月面板数据（75组合×53月=3975观测值），样本量充足
- 发现与Wang and Xu (2015)的A股动量效应较弱一致，进一步证实中国市场动量异象的特殊性

---

### 5.2 实务建议

#### 短期应对（立即执行）

**1. 放弃MOM_24M作为通用因子**

**理由**：
- size_bm组合中完全失效（-40pp）
- 时间样本分割显示显著性崩溃（-25.3pp）
- 高波动性使得未来表现不可预测（CV=0.42）

**操作**：
- 停止在所有投资组合中统一应用MOM_24M
- 重新评估现有多因子模型中动量因子的权重

**2. 条件化使用MOM_24M**

**策略**：仅在size_inv（投资因子）组合中应用MOM_24M

**理由**：
- size_inv前后期稳定性最好（仅-4pp衰退）
- 部分quintile甚至改善（Q2和Q4各+20pp）
- 投资因子与动量效应的交互具有基本面支撑

**操作**：
- 构建"size_inv专用"多因子模型：FF3 + MOM_24M
- 对size_bm和size_op使用不同动量窗口或完全移除动量因子

**3. 探索替代动量窗口**

**策略**：回顾阶段2中排名第二的MOM_4M

**理由**：
- MOM_4M全样本ΔR² = 2.86pp（仅比MOM_24M低0.36pp）
- 短窗口对市场结构变化可能更敏感，适应性更强
- 需验证MOM_4M在样本分割检验中的稳健性

**操作**：
- 重跑稳健性检验，对比MOM_4M与MOM_24M的时间稳定性
- 测试MOM_EQ加权方案是否改善稳健性

#### 中期改进（6-12个月）

**4. 多维度因子组合策略**

**策略**：不同投资组合类型使用不同动量窗口

**设计**：
- **size_bm组合**：放弃动量因子，或测试极短窗口（MOM_2M/MOM_3M）
- **size_inv组合**：继续使用MOM_24M
- **size_op组合**：降低至MOM_12M或MOM_8M

**理由**：
- 承认异质性，避免"一刀切"
- size_op中度衰退但未完全失效，降低窗口可能改善
- size_bm崩溃严重，需要根本性重新设计

**实施**：
- 开发自动化脚本，根据组合类型动态选择动量窗口
- 在回测中验证策略有效性

**5. 引入时变参数模型**

**策略**：基于滚动窗口动态调整因子权重

**方法**：
- **状态切换模型（Regime-Switching Model）**：根据市场状态（牛市/熊市/震荡）调整MOM权重
- **动态因子加权**：使用滚动窗口估计因子权重，每6个月更新

**理由**：
- 滚动窗口分析显示MOM效应呈"过山车"模式（16%~45.5%），存在周期性
- 固定权重无法适应时变环境

**实施**：
- 研发时变因子定价系统
- 结合VIX指数、流动性指标等宏观变量作为状态切换信号

#### 长期研究（1-2年）

**6. 根因调查：2023年后科创板市场结构变化**

**研究方向**：
- **政策变化**：调查2023年后科创板交易规则、信息披露、退市制度等政策调整
- **投资者结构**：分析机构投资者占比、外资流入、散户行为变化
- **流动性演变**：研究换手率、买卖价差、深度等流动性指标

**方法**：
- 访谈监管机构和市场参与者
- 构建微观结构数据集（高频交易数据）
- 跨市场对比（科创板 vs 创业板 vs A股主板）

**7. 因子拥挤效应调查**

**研究问题**：动量策略被广泛采用后是否导致效果减弱？

**方法**：
- 统计动量类量化基金规模和持仓变化
- 分析动量因子收益的序列相关性
- 测试Crowding指标（如资金流共动性）

**8. 机器学习驱动的自适应动量因子**

**策略**：使用机器学习模型动态选择动量窗口

**方法**：
- **特征工程**：市值、流动性、波动率、宏观指标
- **模型选择**：随机森林、LSTM、Transformer
- **目标变量**：未来1个月最优动量窗口（4M/8M/12M/24M）

**理由**：
- 传统静态窗口无法适应时变环境
- 机器学习可捕捉非线性关系和复杂交互效应

**9. 跨市场验证**

**研究范围**：将本研究方法论应用于其他新兴市场

**市场选择**：
- 中国创业板、A股主板
- 亚洲其他科技板块（韩国KOSDAQ、台湾创新板）
- 其他新兴市场（巴西、印度）

**研究价值**：
- 验证发现的普适性
- 识别科创板特有 vs 新兴市场共性

---

### 5.3 局限性讨论

**1. 样本期较短**

- **问题**：FF5+MOM模型仅有29个月数据，稳健性检验样本分割后各13-14个月
- **影响**：时间序列回归的统计功效（Power）受限，可能导致假阴性（Type II Error）
- **改善**：随着时间推移积累更多数据，定期更新稳健性检验

**2. RMW因子数据不完整**

- **问题**：RMW因子仅有11个月完整数据，被迫在稳健性检验中使用FF3而非FF5
- **影响**：
  - 无法评估RMW与MOM的交互效应
  - FF3模型可能存在遗漏变量偏差（Omitted Variable Bias）
- **改善**：等待RMW数据补全后重新运行FF5+MOM稳健性检验

**3. 交易成本未考虑**

- **问题**：本研究基于月度收益，未扣除交易成本（佣金、冲击成本、税费）
- **影响**：实际策略收益可能显著低于回测结果，尤其是短窗口动量因子（换手率高）
- **改善**：
  - 估算不同动量窗口的换手率
  - 引入交易成本模型（如Almgren-Chriss模型）
  - 测试净收益（Net Return）而非总收益（Gross Return）

**4. 流动性约束未考虑**

- **问题**：部分科创板股票流动性极低，大额交易可能无法按月末价格执行
- **影响**：回测收益高估，实盘执行可能面临滑点（Slippage）
- **改善**：
  - 加入流动性筛选（如日均成交额>5000万元）
  - 测试容量约束下的策略表现

**5. 生存偏差（Survivorship Bias）**

- **问题**：未明确说明是否包含退市股票数据
- **影响**：如果只使用存续股票，可能高估策略收益
- **改善**：确认数据集是否包含退市股票，如不包含需调整结论

**6. 前视偏差（Look-Ahead Bias）风险**

- **问题**：投资组合构造使用t期财务数据，但财务报表可能在t+3个月才公布
- **影响**：回测收益高估
- **改善**：引入财务数据公布滞后（如3个月）

---

## 第6章：未来研究方向

### 6.1 时变因子定价模型

**研究问题**：如何在时变环境中动态调整因子权重？

**具体方向**：

**1. 状态切换模型（Regime-Switching Model）**
- **方法**：Markov-Switching回归，识别"高动量效应"和"低动量效应"状态
- **状态变量**：VIX指数、流动性指标、市场波动率
- **预期发现**：动量效应在牛市和高波动期更强

**2. 时变贝塔模型（Time-Varying Beta Model）**
- **方法**：GARCH-in-Mean、DCC-GARCH
- **目标**：建模MOM系数的时间序列动态
- **应用**：动态风险管理

**3. 滚动窗口自适应权重**
- **方法**：每6个月重新估计因子权重，使用过去24个月数据
- **优化目标**：最大化夏普比率或信息比率
- **挑战**：避免过度拟合（Overfitting）

---

### 6.2 机器学习与因子定价

**研究问题**：机器学习能否改善传统线性因子模型？

**具体方向**：

**1. 自适应动量窗口选择**
- **模型**：随机森林、梯度提升树（XGBoost）
- **特征**：市值、流动性、波动率、行业、宏观指标
- **目标**：预测每个组合的最优动量窗口（4M/8M/12M/24M）
- **预期**：在size_bm和size_op中选择更短窗口，在size_inv中保持24M

**2. 深度学习因子模型**
- **模型**：LSTM、Transformer
- **输入**：多因子时间序列（FF5 + 多窗口MOM）
- **输出**：组合收益预测
- **优势**：捕捉非线性关系和复杂交互效应

**3. 可解释AI（Explainable AI）**
- **方法**：SHAP值、LIME
- **目标**：解释机器学习模型的因子选择逻辑
- **挑战**：平衡预测性能和可解释性

---

### 6.3 市场结构与制度研究

**研究问题**：2023年后科创板发生了什么导致动量效应衰减？

**具体方向**：

**1. 政策变化影响**
- **调查内容**：交易规则、信息披露、退市制度
- **方法**：事件研究法（Event Study）
- **假设**：政策变化改变了投资者行为和信息传播速度

**2. 投资者结构演变**
- **数据需求**：机构持仓、外资流入、散户账户数
- **方法**：回归分析，控制变量为投资者结构指标
- **假设**：机构投资者占比提升削弱了动量效应

**3. 流动性冲击**
- **指标**：换手率、买卖价差、深度、Amihud非流动性指标
- **方法**：面板回归，控制流动性
- **假设**：流动性恶化导致动量信号被噪音淹没

**4. 因子拥挤效应（Factor Crowding）**
- **数据需求**：动量类量化基金规模和持仓
- **方法**：Crowding指标（资金流共动性）、拥挤度测算
- **假设**：动量策略过度拥挤导致效果减弱

---

### 6.4 跨市场与跨资产验证

**研究问题**：本研究发现在其他市场是否成立？

**具体方向**：

**1. 中国其他板块**
- **市场**：A股主板、创业板、北交所
- **方法**：复现本研究全流程（多窗口优化+三维稳健性检验）
- **预期**：主板动量效应可能更稳定（流动性更好、投资者更成熟）

**2. 亚洲科技板块**
- **市场**：韩国KOSDAQ、台湾创新板、日本东证Mothers
- **比较**：科创板 vs 其他亚洲科技板块
- **预期**：发现亚洲科技板块的共性和特殊性

**3. 全球新兴市场**
- **市场**：巴西、印度、南非、土耳其
- **方法**：跨国面板数据分析
- **预期**：验证时变性和条件依赖性是否为新兴市场共性

**4. 跨资产类别**
- **资产**：债券、商品、外汇、加密货币
- **方法**：构造多资产动量因子
- **预期**：动量效应在不同资产类别的异质性

---

### 6.5 行为金融学视角

**研究问题**：投资者行为如何驱动动量效应的时变性？

**具体方向**：

**1. 投资者情绪与动量效应**
- **情绪指标**：百度搜索指数、社交媒体情绪、新闻情绪
- **方法**：情绪指标与MOM显著性的相关性分析
- **假设**：高情绪期动量效应更强

**2. 注意力驱动的动量（Attention-Driven Momentum）**
- **注意力指标**：新闻报道数量、分析师覆盖、交易量异常
- **方法**：注意力加权动量因子
- **假设**：高注意力股票的动量效应更持久

**3. 保守偏差与锚定效应**
- **方法**：分析投资者对科创板公司盈利预期的调整速度
- **假设**：投资者对高科技公司盈利预期调整缓慢，导致动量效应

---

### 6.6 组合优化与风险管理

**研究问题**：如何在实务中应用条件化动量策略？

**具体方向**：

**1. 条件化多因子组合优化**
- **方法**：均值-方差优化（MVO）、Black-Litterman模型
- **约束**：size_bm放弃动量，size_inv使用MOM_24M，size_op使用MOM_12M
- **目标**：最大化夏普比率

**2. 动态对冲策略**
- **方法**：使用股指期货对冲市场风险（MKT），保留动量Alpha
- **挑战**：科创板50指数期货流动性有限

**3. 尾部风险管理**
- **方法**：CVaR约束、下行风险控制
- **目标**：在保持动量收益的同时控制极端损失

---

## 第7章：结论

### 7.1 核心发现总结

本研究对中国科创板市场进行了系统化的多窗口动量因子研究，得出以下三个核心发现：

**1. 全样本最优 ≠ 稳健有效**

- **优化阶段（29个月全样本）**：MOM_24M凭借最高的R²改善（3.22pp）和MOM显著性（41.8%），在加权评分框架中以82.5分胜出
- **稳健性检验（53个月样本分割）**：时间稳定性完全崩溃，MOM显著性从39.3% → 14.0%（-25.3pp）
- **教训**：因子优化不能仅依赖全样本表现，必须进行多维度稳健性检验

**2. 动量因子具有严重的时变性和条件依赖性**

- **时变性**：
  - 滚动窗口分析显示时间相关系数-0.37，呈系统性下降趋势
  - MOM显著性高波动（16%~45.5%，CV=0.42），呈"过山车"模式
  - 2025-07窗口创新低（16.0%），趋势未逆转

- **条件依赖性**：
  - **size_bm（价值维度）**：-40pp，完全失效
  - **size_inv（投资维度）**：-4pp，最稳定
  - **size_op（运营维度）**：-24.7pp，中度衰退

**3. R²改善与动量定价能力可能背离**

- **悖论现象**：后期R²从79.2% → 89.9%（+10.7pp），但MOM显著性从39.3% → 14.0%（-25.3pp）
- **解释**：FF3其他因子在后期吸收了部分动量效应，导致MOM增量解释力下降
- **启示**：R²不应作为因子定价能力的唯一评估指标，需结合因子显著性和经济意义

---

### 7.2 主要建议

**学术研究建议**：

1. **摒弃"通用因子"假设**：承认因子定价能力的时变性和条件依赖性
2. **多维度稳健性检验成为标配**：样本分割、滚动窗口、子样本分解应成为因子研究的必要步骤
3. **探索时变因子模型**：状态切换模型、动态因子加权、机器学习自适应
4. **重视新兴市场特殊性**：科创板、创业板等高科技板块的因子定价规律可能不同于成熟市场

**实务应用建议**：

1. **短期（立即执行）**：
   - 放弃MOM_24M作为通用因子
   - 条件化使用：仅在size_inv组合中应用MOM_24M
   - 探索MOM_4M等替代窗口的稳健性

2. **中期（6-12个月）**：
   - 不同投资组合类型使用不同动量窗口
   - 引入时变参数模型，基于滚动窗口动态调整因子权重

3. **长期（1-2年）**：
   - 调查2023年后科创板市场结构变化
   - 开发机器学习驱动的自适应动量因子
   - 进行跨市场验证

---

### 7.3 研究价值

**学术价值**：

1. **填补研究空白**：首次系统化研究科创板市场的多窗口动量因子
2. **挑战传统假设**：揭示动量因子的时变性和条件依赖性，挑战"通用因子"假设
3. **方法论贡献**：构建加权评分框架和三维度稳健性检验方法，可复制至其他市场
4. **发现R²悖论**：R²改善与MOM定价能力背离，提示多重共线性和因子替代效应

**实务价值**：

1. **避免策略失效**：警示实务工作者不能盲目使用全样本最优因子
2. **条件化策略**：提供可操作的条件化使用建议（size_inv使用MOM_24M）
3. **风险管理**：揭示动量因子的高波动性和下降趋势，有助于风险控制
4. **后续优化方向**：为时变模型、机器学习应用提供实证基础

---

### 7.4 研究局限与展望

**局限性**：

1. 样本期较短（29个月优化期、53个月稳健性检验期）
2. RMW因子数据不完整，被迫使用FF3而非FF5
3. 未考虑交易成本和流动性约束
4. 可能存在生存偏差和前视偏差

**展望**：

随着数据积累和方法创新，未来研究可在以下方向深化：

1. **数据层面**：等待更长样本期、补全RMW数据、引入微观结构数据
2. **方法层面**：应用时变模型、机器学习、行为金融学方法
3. **应用层面**：开发条件化多因子策略、动态风险管理工具
4. **扩展层面**：跨市场验证、跨资产类别研究

---

## 附录：文件清单

### 核心代码脚本

| 文件名 | 功能描述 | 关键输出 |
|--------|---------|---------|
| `code/A_data_prep.py` | 原始Excel数据转Parquet | `data/processed/*.parquet` |
| `code/B_etl_monthly.py` | 月度数据ETL | 月度面板数据 |
| `code/C_portfolio_construction.py` | 投资组合构造(5×5×3=75) | `data/processed/portfolio_returns_*.parquet` |
| `code/D_factor_construction.py` | FF5因子构造 | `data/processed/factor_returns.parquet` |
| `code/L_momentum_multiwindow.py` | 多窗口动量因子(4/8/12/24+EQ) | `data/processed/factor_returns_multiwindow.parquet` |
| `code/L_regression_multiwindow.py` | 6模型回归对比 | `docs/tables/multiwindow_regression_summary.csv` |
| `code/L_momentum_comparison.py` | 单因子vs加权对比 | `docs/tables/multiwindow_performance_matrix.csv` |
| `code/L_momentum_optimization_final.py` | 优化决策 | `docs/tables/optimization_scorecard.csv` |
| `code/M_robustness_sample_split.py` | 样本分割检验 | `docs/tables/robustness_sample_split_*.csv` |
| `code/M_robustness_rolling_window.py` | 滚动窗口分析 | `docs/tables/robustness_rolling_window_stats.csv` |
| `code/N_generate_final_report.py` | **生成本报告** | `docs/research_synthesis_report.md` |

### 关键数据表格

| 文件名 | 内容描述 |
|--------|---------|
| `docs/tables/optimization_scorecard.csv` | 5个动量模型优化评分排名 |
| `docs/tables/robustness_sample_split_comparison.csv` | 样本分割前后期对比 |
| `docs/tables/robustness_rolling_window_stats.csv` | 5个滚动窗口统计 |
| `docs/tables/robustness_by_portfolio_type.csv` | 三类投资组合稳健性 |
| `docs/tables/robustness_quintile_breakdown.csv` | Quintile级别细化分析 |

### 研究报告

| 文件名 | 内容描述 |
|--------|---------|
| `docs/momentum_optimization_report.md` | 阶段2优化决策报告 |
| `docs/robustness_test_summary.md` | 阶段3稳健性检验综合报告 |
| `docs/research_synthesis_report.md` | **本报告：项目研究综合报告** |
| `README.md` | 项目文档和使用指南 |

### 自动化脚本

| 文件名 | 功能描述 |
|--------|---------|
| `run_pipeline.sh` | 端到端自动化执行脚本 |

---

**报告完成时间**：{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}  
**报告生成脚本**：`code/N_generate_final_report.py`  
**项目仓库**：FamaFrench5InSTAR  

---

**致谢**：感谢科创板上市公司提供的公开数据，感谢Fama-French因子理论为本研究提供的理论基础。

**声明**：本研究仅供学术交流和实务参考，不构成投资建议。投资者应独立判断并承担投资风险。
"""

report = report.replace("{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", generated_time, 1)
report = report.replace("{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", completed_time, 1)

# 写入报告文件
output_path = Path('docs/research_synthesis_report.md')
output_path.write_text(report, encoding='utf-8')

# 统计行数并打印
line_count = len(report.splitlines())
file_size = output_path.stat().st_size / 1024  # KB

print(f"✅ 项目研究综合报告生成成功！")
print(f"📁 文件路径: {output_path}")
print(f"📊 报告行数: {line_count} 行")
print(f"💾 文件大小: {file_size:.1f} KB")
print(f"📅 生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
